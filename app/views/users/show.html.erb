<% content_for :title do   %>
  <ol class="breadcrumb">
    <li>Accounts</li>
    <li><%= link_to 'Users', users_path %></li>
  </ol>
<% end %>
<% content_for :section do %>User <%= @user.display_name %><% end %>

<% if can? :update, @user and not @user.confirmed? %>
  <div class="alert alert-warning">
    <i class="fa fa-exclamation-triangle"></i> This user's email address has not been confirmed yet.
  </div>
<% end %>
<% if can? :update, @user and not @user.enabled %>
  <div class="alert alert-warning">
    <i class="fa fa-exclamation-triangle"></i> This account is disabled and cannot be used for signing in using any authentication backend.
  </div>
<% end %>
<% if can? :update, @user and @user.access_locked? %>
  <div class="alert alert-warning">
    <i class="fa fa-lock"></i> This account is locked and cannot sign in on the panel.
  </div>
<% end %>

<div class="pull-right">
  <div class="btn-group">
    <% if can? :update, @user %>
      <%= link_to edit_user_path(@user), :class => 'btn btn-secondary btn-sm', :title => 'Edit user', :data => {:toggle => 'tooltip'}  do %>
        <i class="fa fa-pencil"></i>
      <% end %>
    <% end %>
    <% if can? :destroy, @user %>
      <%= link_to user_path(@user),
                            :method => :delete,
                            :title => 'Delete user',
                            data: { confirm: 'Are you sure you want to delete this user?',
                                    :toggle => 'tooltip' },
                            :class => 'btn btn-secondary btn-sm' do %>
        <i class="fa fa-trash"></i>
      <% end %>
    <% end %>
  </div>
</div>

<table class="attribute-table">
  <tr>
    <td>Username</td>
    <td><%= @user.uid %></td>
  </tr>
  <tr>
    <td>Full name</td>
    <td><%= @user.display_name %></td>
  </tr>
  <tr>
    <td>Email</td>
    <td><%= @user.email %></td>
  </tr>
  <tr>
    <td>Notifications</td>
    <td>
      <% if @user.enable_notifications %>
        Email and web
      <% else %>
        Web only
      <% end %>
    </td>
  </tr>
  <tr>
    <td>State</td>
    <td>
      <% if @user.enabled %>
        <span class="text-success">Enabled</span>
      <% else %>
        <span class="text-danger">Disabled</span>
      <% end %>
    </td>
  </tr>
</table>

<div class="title-heading">
  <h3>Authorization</h3>
</div>

<p>
  <% if @user.roles.any? %>
    <%= @user.first_name %> has been assigned the following roles:
    <strong><%= @user.roles.order(:order => :desc).map { |r| r.display_name }.join ', ' %></strong>
  <% else %>
    <em><%= @user.first_name %> does not have any assigned roles</em>
  <% end %>
</p>

<div class="title-heading">
  <h3>Groups</h3>
</div>

<div class="row">
  <div class="col-xs-8">
    <% if @user.groups.select { |g| can? :read, g }.empty? %>
      <em>No groups found</em>
    <% else %>
      <table class="table">
        <thead>
          <th>Group</th>
          <th>Status</th>
        </thead>
        <tbody>
          <% @user.groups.select { |g| can? :read, g }.each do |group| %>
            <tr>
              <td><%= link_to group.display_name, group_path(group) %></td>
              <td>
                <%= group.owner == @user ? 'Owner' : 'Member' %>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    <% end %>
  </div>
</div>

<div class="title-heading">
  <h3>Recent activity</h3>
</div>

<% if @events %>
  <ul class="list-group">
  <% @events.each do |event| %>
    <li class="list-group-item">
      <% if event.result %>
        <%= event.user.first_name %> signed in
      <% else %>
        <%= event.user.first_name %> failed to sign in
      <% end %>
      <br>
      <span class="text-timestamp"><%= time_ago_in_words(event.timestamp) %> ago</span>
    </li>
  <% end %>
  </ul>
<% else %>
  <em>No recent activity recorded</em>
<% end %>
